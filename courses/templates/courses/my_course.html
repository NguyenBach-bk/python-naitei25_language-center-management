{% extends "base.html" %}
{% load i18n course_media %}

{% block title %}{{ page_title }} — {{ C.SITE.NAME }}{% endblock %}

{% block content %}
<h1 class="h4 mb-3">{{ page_title }}</h1>

{% if courses %}
  <div class="row g-4">
    {% for course in courses %}
      <div class="col-md-6 col-lg-4">
        <div class="card h-100">
          <div class="ratio ratio-16x9">
            {% course_cover_img course classes="card-img-top object-fit-cover" %}
          </div>
          <div class="card-body d-flex flex-column">
            <h5 class="card-title mb-1">
              {% firstof course.title course.name _("Khóa học") %}
            </h5>
            <p class="card-text text-muted small mb-3">
              <i class="bi bi-collection me-1"></i>{{ course.lessons.all|length|default:"0" }} {% trans "Bài học" %}
            </p>

            {# Build URLs (slug ưu tiên, fallback by-id) #}
            {% if course.slug %}
              {% url 'courses:detail' course.slug as detail_url %}
              {% url 'courses:start'  course.slug as start_url %}
            {% else %}
              {% url 'courses:detail_by_id' course.pk as detail_url %}
              {% url 'courses:start_by_id'  course.pk as start_url %}
            {% endif %}

            <div class="mt-auto">
              <a class="btn btn-teal w-100 mb-2" href="{{ start_url }}">{% trans "Vào học" %}</a>

              {# Hiển thị thông tin duyệt #}
              {% if course.my_enrollments and course.my_enrollments.0 %}
                {% with enr=course.my_enrollments.0 %}
                  <div class="small text-muted">
                    <i class="bi bi-check-circle-fill text-success me-1"></i>
                    {% trans "Đã được chấp thuận" %}
                    {% if enr.approved_at %} — {{ enr.approved_at|date:"d/m/Y H:i" }}{% endif %}
                  </div>
                {% endwith %}
              {% endif %}
            </div>
          </div>
          <div class="card-footer bg-transparent border-0">
            <a class="small" href="{{ detail_url }}">{% trans "Xem chi tiết khóa học" %} →</a>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  {# Pagination (nếu dùng paginate_by) #}
  {% if is_paginated %}
    <nav class="mt-4">
      <ul class="pagination">
        {% if page_obj.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">&laquo;</a></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">
          {% blocktrans %}Trang {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}{% endblocktrans %}
        </span></li>
        {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">&raquo;</a></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

{% else %}
  <div class="alert alert-info">
    {% trans "Bạn chưa có khóa học nào được chấp thuận." %}
  </div>
{% endif %}
{% endblock %}
